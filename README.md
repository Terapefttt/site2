# CharmyAI Mini-App –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç Telegram Mini-App –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ CharmyAI –±–æ—Ç–∞ —Å —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç—å—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫.

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
aiChat/
‚îú‚îÄ‚îÄ site/                           # Mini-App —Ñ–∞–π–ª—ã
‚îÇ   ‚îú‚îÄ‚îÄ bot_settings.html          # –û—Å–Ω–æ–≤–Ω–æ–π HTML —Ñ–∞–π–ª mini-app
‚îÇ   ‚îú‚îÄ‚îÄ config.js                  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API –∏ Telegram Web App
‚îÇ   ‚îú‚îÄ‚îÄ fields_mapping.json        # –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–æ–ª–µ–π –¥–ª—è –ë–î
‚îÇ   ‚îî‚îÄ‚îÄ README.md                  # –≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
‚îú‚îÄ‚îÄ settings_api_server.py         # –°–µ—Ä–≤–µ—Ä–Ω–æ–µ API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
‚îú‚îÄ‚îÄ requirements_api.txt           # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è API —Å–µ—Ä–≤–µ—Ä–∞
‚îî‚îÄ‚îÄ settings.db                    # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
```

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ HTML:
- ‚úÖ **–ê–≤—Ç–æ–≤—ã–±–æ—Ä —Ä–æ–º–∞–Ω—Ç–∏–∫–∏**: –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- ‚úÖ **–£–±—Ä–∞–Ω–∞ "–ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"**: –†–∞–∑–¥–µ–ª –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω
- ‚úÖ **–ü–µ—Ä–µ–Ω–æ—Å "–ö–∞–∫ –≤–µ–¥—ë—Ç —Å–µ–±—è –ø–µ—Ä—Å–æ–Ω–∞–∂"**: –ü–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ —Å–µ–∫—Ü–∏—é "–ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:
- üîÑ **–ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫**: –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- üíæ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î**: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `settings.db`
- üîê **–í–∞–ª–∏–¥–∞—Ü–∏—è Telegram**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- üì± **–ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Web App**: –ù–∞—Ç–∏–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ

## üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API —Å–µ—Ä–≤–µ—Ä–∞

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:
```bash
pip install -r requirements_api.txt
```

#### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
export BOT_TOKEN="–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞"
```

#### –ó–∞–ø—É—Å–∫ API —Å–µ—Ä–≤–µ—Ä–∞:
```bash
python settings_api_server.py
```

–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://0.0.0.0:8080`

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Mini-App

#### –û–±–Ω–æ–≤–∏—Ç–µ `config.js`:
–ó–∞–º–µ–Ω–∏—Ç–µ URL –≤ —Ñ–∞–π–ª–µ `site/config.js`:
```javascript
baseUrl: 'https://your-domain.com/api',  // ‚Üê –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω
```

#### –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥:
- `bot_settings.html`
- `config.js`
- `fields_mapping.json` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º)

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞

–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è Mini-App –≤ –≤–∞—à–µ–º –±–æ—Ç–µ:

```python
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo

async def settings_command(message):
    webapp = WebAppInfo(url="https://your-domain.com/bot_settings.html")
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞", web_app=webapp)]
    ])
    await message.answer("–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:", reply_markup=keyboard)
```

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã `user_settings`:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `user_id` | INTEGER | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram (Primary Key) |
| `character_name` | TEXT | –ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ |
| `message_length` | TEXT | –î–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (short/medium/long) |
| `secondary_characters` | TEXT | –î–æ–ø—É—Å–∫ –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π |
| `involvement` | TEXT | –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ |
| `plot_predictability` | TEXT | –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å —Å—é–∂–µ—Ç–∞ |
| `plot_intensity` | TEXT | –ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏—è–º–∏ |
| `setting` | TEXT | –ú–µ—Å—Ç–æ –¥–µ–π—Å—Ç–≤–∏—è, —Å–µ—Ç—Ç–∏–Ω–≥ |
| `user_role` | TEXT | –†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `romance_level` | TEXT | –£—Ä–æ–≤–µ–Ω—å —Ä–æ–º–∞–Ω—Ç–∏–∫–∏ |
| `created_at` | TIMESTAMP | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |
| `updated_at` | TIMESTAMP | –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

## üì° API Endpoints

### `POST /api/settings/load`
–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "user_id": 123456789,
  "init_data": "auth_data_from_telegram"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "data": {
    "settings": { ... },
    "has_existing_settings": true
  }
}
```

### `POST /api/settings/save`
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ó–∞–ø—Ä–æ—Å:**
```json
{
  "user_id": 123456789,
  "init_data": "auth_data_from_telegram",
  "settings": {
    "characterName": "–ê–ª–∏—Å–∞",
    "messageLength": "medium",
    "romance": "maximum",
    ...
  }
}
```

### `GET /api/health`
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–ª–µ–π

–§–∞–π–ª `fields_mapping.json` —Å–æ–¥–µ—Ä–∂–∏—Ç:
- –°—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –ú–∞–ø–ø–∏–Ω–≥ –º–µ–∂–¥—É frontend –∏ database –ø–æ–ª—è–º–∏
- –ü—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è enum –ø–æ–ª–µ–π

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è Telegram –¥–∞–Ω–Ω—ã—Ö**: –ü—Ä–æ–≤–µ—Ä–∫–∞ HMAC –ø–æ–¥–ø–∏—Å–∏
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã —Å—Ç—Ä–æ–∫ –∏ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- ‚úÖ **CORS**: –ù–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram Mini-App
- ‚úÖ **SQL Injection**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## üìã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –±–æ—Ç–µ

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –±–æ—Ç–µ:

```python
import aiosqlite

async def get_user_settings(user_id: int) -> dict:
    async with aiosqlite.connect('settings.db') as db:
        cursor = await db.execute(
            "SELECT * FROM user_settings WHERE user_id = ?",
            (user_id,)
        )
        row = await cursor.fetchone()
        
        if row:
            columns = [desc[0] for desc in cursor.description]
            return dict(zip(columns, row))
        
        return None
```

## üö® –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

API —Å–µ—Ä–≤–µ—Ä –≤–µ–¥–µ—Ç –ª–æ–≥–∏ –≤:
- –ö–æ–Ω—Å–æ–ª—å (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
- –§–∞–π–ª `settings_api.log` (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã API:
```bash
curl -X GET http://localhost:8080/api/health
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:
```bash
tail -f settings_api.log
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î:
```bash
sqlite3 settings.db "SELECT * FROM user_settings LIMIT 5;"
```

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –ë–î**: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
2. **–ü—É—Å—Ç—ã–µ –ø–æ–ª—è**: –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ, –≤ –ë–î –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è**: –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è
4. **–†–æ–º–∞–Ω—Ç–∏–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π"

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π:
1. –û–±–Ω–æ–≤–∏—Ç–µ `fields_mapping.json`
2. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–µ –≤ SQL —Å—Ö–µ–º—É –≤ `settings_api_server.py`
3. –û–±–Ω–æ–≤–∏—Ç–µ HTML —Ñ–æ—Ä–º—É
4. –î–æ–±–∞–≤—å—Ç–µ –≤ `config.js` defaults

---

**–ê–≤—Ç–æ—Ä**: CharmyAI Team  
**–í–µ—Ä—Å–∏—è**: 1.0  
**–î–∞—Ç–∞**: 2025-01-27 